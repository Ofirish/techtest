<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>×”×›× ×” ×œ×‘×—×™× ×” - ××“×¢×™ ×”×˜×›× ×•×œ×•×’×™×”</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --light-bg: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #333;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Rubik', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--light-bg);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            height: 100dvh;
            flex-direction: row;
        }

        /* --- Layout --- */
        #mindmap-container {
            flex: 2;
            position: relative;
            background-color: #eef2f5;
            background-image: radial-gradient(#dfe6e9 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            touch-action: none;
        }

        #sidebar {
            flex: 1;
            max-width: 400px;
            background: white;
            box-shadow: -4px 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            z-index: 10;
            border-left: 1px solid #e1e1e1;
        }

        .sidebar-header {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        h2 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin: 0 0 5px 0;
            font-weight: 700;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin: 0;
        }

        .content-body {
            line-height: 1.7;
            font-size: 0.95rem;
            color: #444;
        }
        
        .content-body ul { padding-right: 18px; }
        .content-body li { margin-bottom: 10px; }

        /* --- Buttons --- */
        .btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.2s;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(52, 152, 219, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); background-color: var(--accent-hover); }

        /* --- D3 Nodes & Links --- */
        .node circle {
            stroke: var(--accent-color);
            stroke-width: 2.5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        /* New Styles for Pill Boxes */
        .pill-rect {
            fill: #ffffff;
            stroke: var(--accent-color);
            stroke-width: 2px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.08));
            cursor: pointer;
            transition: all 0.2s;
        }

        .node:hover .pill-rect {
            fill: #f8fbff;
            stroke: var(--accent-hover);
        }

        .pill-text {
            font-family: 'Rubik', sans-serif;
            font-size: 14px;
            font-weight: 500;
            fill: #2c3e50;
            pointer-events: none; /* Let clicks pass to the group/rect */
            text-shadow: none;
        }

        .link {
            fill: none;
            stroke: #cbd5e0;
            stroke-width: 2px;
            transition: stroke 0.3s;
        }

        /* --- Mobile Layout --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            
            #mindmap-container {
                flex: 1.4;
                border-bottom: 1px solid #ddd;
            }

            #sidebar {
                flex: 1;
                max-width: 100%;
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.08);
                border-left: none;
                margin-top: -20px; /* Slight overlap */
            }

            .sidebar-header { padding: 15px 20px; }
            .sidebar-content { padding: 15px 20px 80px 20px; }
        }

        /* --- Flashcard Modal --- */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
            padding: 20px;
        }

        .flashcard-wrapper {
            width: 100%;
            max-width: 400px;
            perspective: 1000px;
        }

        .flashcard-container {
            width: 100%;
            height: 280px;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .flashcard-container.flipped { transform: rotateY(180deg); }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .flashcard-front {
            background: #fff;
            color: var(--primary-color);
        }

        .flashcard-back {
            background: var(--accent-color);
            color: white;
            transform: rotateY(180deg);
        }

        .card-controls {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .control-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            width: 50px; height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        .control-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }

        .close-modal {
            position: absolute;
            top: 20px; right: 20px;
            background: rgba(255,255,255,0.1);
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2 id="detail-title">×—×•××¨ ×œ×‘×—×™× ×”</h2>
            <p class="subtitle" id="detail-subtitle">×‘×—×¨ × ×•×©× ××”××¤×” ×›×“×™ ×œ×”×ª×—×™×œ</p>
        </div>
        
        <div class="sidebar-content">
            <div id="welcome-msg">
                <div class="content-body">
                    <p>×‘×¨×•×›×™× ×”×‘××™× ×œ××¢×¨×›×ª ×”×—×–×¨×” ×”××™× ×˜×¨××§×˜×™×‘×™×ª.</p>
                    <p><strong>××™×š ×–×” ×¢×•×‘×“?</strong></p>
                    <ul>
                        <li>ğŸ” ×œ×—×¦×• ×¢×œ ×”×ª×•×•×™×•×ª ×‘××¤×” ×œ×¤×ª×™×—×ª × ×•×©××™×.</li>
                        <li>ğŸ“– ×§×¨××• ××ª ×”×¡×™×›×•× ×©×™×•×¤×™×¢ ×›××Ÿ.</li>
                        <li>ğŸ§  ×ª×¨×’×œ×• ×¢× ×›×¨×˜×™×¡×™×•×ª ×”×–×™×›×¨×•×Ÿ.</li>
                    </ul>
                </div>
            </div>
            
            <div id="detail-view" style="display:none;">
                <div id="detail-content" class="content-body"></div>
                <button id="start-cards-btn" class="btn">
                    <span>×ª×¨×’×•×œ ×›×¨×˜×™×¡×™×•×ª</span>
                    <span>ğŸ´</span>
                </button>
            </div>
        </div>
    </div>

    <div id="mindmap-container"></div>

    <!-- Modal -->
    <div id="modal-overlay">
        <div class="close-modal" onclick="closeModal()">&times;</div>
        
        <div class="flashcard-wrapper">
            <div class="flashcard-container" onclick="flipCard()">
                <div class="flashcard-face flashcard-front">
                    <span style="font-size:3rem; margin-bottom:15px;">â“</span>
                    <h3 style="margin:0 0 15px 0; opacity:0.6; font-size:0.9rem;">×©××œ×”</h3>
                    <p id="card-question" style="font-size: 1.2rem; font-weight: 600; line-height:1.4;">?</p>
                    <p style="margin-top:auto; font-size:0.8rem; color:#95a5a6; opacity:0.8;">(×œ×—×¥ ×›×“×™ ×œ×”×¤×•×š)</p>
                </div>
                <div class="flashcard-face flashcard-back">
                    <span style="font-size:3rem; margin-bottom:15px;">ğŸ’¡</span>
                    <h3 style="margin:0 0 15px 0; opacity:0.8; font-size:0.9rem;">×ª×©×•×‘×”</h3>
                    <p id="card-answer" style="font-size: 1.1rem; line-height:1.5;">!</p>
                </div>
            </div>
            
            <div class="card-controls">
                <button class="control-btn" onclick="prevCard(event)">&#8594;</button>
                <span id="card-counter" style="color:white; font-weight:600; letter-spacing:1px;">1 / 5</span>
                <button class="control-btn" onclick="nextCard(event)">&#8592;</button>
            </div>
        </div>
    </div>

<script>
    const data = {
        name: "×—×•××¨ ×œ×‘×—×™× ×”",
        content: "× ×•×©××™ ×”×‘×—×™× ×” ×‘××“×¢×™ ×”×˜×›× ×•×œ×•×’×™×”: ××•×©×’×™ ×™×¡×•×“, ×ª×”×œ×™×š ×”×—×§×¨, ××™×•×× ×•×™×•×ª ×•×¢×™×©×•×Ÿ.",
        flashcards: [],
        children: [
            {
                name: "××•×©×’×™ ×™×¡×•×“",
                content: `
                    <ul>
                        <li><strong>××“×¢ (Science):</strong> ×¢×•×¡×§ ×‘"×œ××”?". ×”××˜×¨×” ×”×™× ×”×‘× ×” ×•×—×§×™×¨×” ×©×œ ×¢×•×œ× ×”×˜×‘×¢ ×•×—×•×§×™×• (×¤×™×–×™×§×”, ×›×™××™×”, ×‘×™×•×œ×•×’×™×”).</li>
                        <li><strong>×˜×›× ×•×œ×•×’×™×” (Technology):</strong> ×¢×•×¡×§×ª ×‘"××™×š?". ×”××˜×¨×” ×”×™× ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×•××¢× ×” ×œ×¦×¨×›×™× ×× ×•×©×™×™×.</li>
                        <li><strong>×§×©×¨×™ ×’×•××œ×™×Ÿ:</strong> ×”××“×¢ ××¡×¤×§ ×™×“×¢ ×œ×˜×›× ×•×œ×•×’×™×”, ×•×”×˜×›× ×•×œ×•×’×™×” ××¡×¤×§×ª ×›×œ×™× ×œ××“×¢. ××—×“ ×××™×¥ ××ª ×”××—×¨.</li>
                        <li><strong>××•×¨×™×™× ×•×ª ×˜×›× ×•×œ×•×’×™×ª:</strong> ×”×™×›×•×œ×ª ×œ×”×‘×™×Ÿ, ×œ×§×‘×œ ×”×—×œ×˜×•×ª ×•×œ×ª×¤×§×“ ×‘×—×‘×¨×” ××•×“×¨× ×™×ª.</li>
                    </ul>`,
                flashcards: [
                    { q: "××”×™ ×”××˜×¨×” ×”×¢×™×§×¨×™×ª ×©×œ ×”××“×¢?", a: "×”×‘× ×” ×•×—×§×™×¨×” ×©×œ ×¢×•×œ× ×”×˜×‘×¢ ×•×”×—×•×§×™× ×”×©×•×œ×˜×™× ×‘×•." },
                    { q: "××”×™ ×”××˜×¨×” ×”×¢×™×§×¨×™×ª ×©×œ ×”×˜×›× ×•×œ×•×’×™×”?", a: "×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×•××¢× ×” ×œ×¦×¨×›×™× ×× ×•×©×™×™× ×›×“×™ ×œ×”×™×˜×™×‘ ××ª ×ª× ××™ ×”×—×™×™×." },
                    { q: "××”×™ ××•×¨×™×™× ×•×ª ×˜×›× ×•×œ×•×’×™×ª?", a: "×”×™×›×•×œ×ª ×œ×”×©×ª××© ×‘×™×“×¢ ×›×“×™ ×œ×”×ª××•×“×“ ×•×œ×§×‘×œ ×”×—×œ×˜×•×ª ×‘×¡×‘×™×‘×” ×˜×›× ×•×œ×•×’×™×ª." }
                ],
                children: [
                    { name: "××“×¢", content: "×¢×•×¡×§ ×‘×—×§×¨ ×¢×•×œ× ×”×˜×‘×¢ ×•×—×•×§×™×•. ×©×•××œ '×œ××”?'. ×”×ª×•×¦×¨ ×”×•× ×™×“×¢." },
                    { name: "×˜×›× ×•×œ×•×’×™×”", content: "×¢×•×¡×§×ª ×‘×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×× ×•×©×™×•×ª. ×©×•××œ×ª '××™×š?'. ×”×ª×•×¦×¨ ×”×•× ××•×¦×¨ ××• ××›×©×™×¨." }
                ]
            },
            {
                name: "×ª×”×œ×™×š ×”×—×§×¨",
                content: `
                    <strong>×©×œ×‘×™ ×”×—×§×¨ ×”××“×¢×™:</strong>
                    <ol>
                        <li>×–×™×”×•×™ ×‘×¢×™×” ×•×¦×•×¨×š.</li>
                        <li>× ×™×¡×•×— ×©××œ×ª ×—×§×¨ (×§×©×¨ ×‘×™×Ÿ ××©×ª× ×™×).</li>
                        <li>×”×©×¢×¨×” (×ª×©×•×‘×” ××¤×©×¨×™×ª ×©× ×™×ª×Ÿ ×œ×‘×“×•×§).</li>
                        <li>×ª×›× ×•×Ÿ ×”× ×™×¡×•×™ (×‘×™×“×•×“ ××©×ª× ×™×).</li>
                        <li>×ª×•×¦××•×ª ×•××¡×§× ×•×ª.</li>
                    </ol>
                    <strong>××©×ª× ×™×:</strong>
                    <ul>
                        <li><strong>×‘×œ×ª×™ ×ª×œ×•×™:</strong> ×”×’×•×¨× ×©×”×—×•×§×¨ ××©× ×” (×”×¡×™×‘×”).</li>
                        <li><strong>×ª×œ×•×™:</strong> ×”×’×•×¨× ×”× ××“×“ (×”×ª×•×¦××”).</li>
                        <li><strong>×‘×§×¨×”:</strong> ×§×‘×•×¦×” ×œ×”×©×•×•××” ×œ×œ× ×”×’×•×¨× ×”××©×¤×™×¢.</li>
                    </ul>`,
                flashcards: [
                    { q: "××”×• ×”××©×ª× ×” ×”×‘×œ×ª×™ ×ª×œ×•×™?", a: "×”×’×•×¨× ×©×”×—×•×§×¨ ××©× ×” ×‘××›×•×•×Ÿ ×›×“×™ ×œ×‘×“×•×§ ××ª ×”×©×¤×¢×ª×• (×”×’×•×¨× ×”××©×¤×™×¢)." },
                    { q: "××”×• ×”××©×ª× ×” ×”×ª×œ×•×™?", a: "×”×’×•×¨× ×”× ××“×“ ×‘× ×™×¡×•×™, ×”××©×ª× ×” ×›×ª×•×¦××” ××”×˜×™×¤×•×œ (×”×’×•×¨× ×”××•×©×¤×¢)." },
                    { q: "××”×™ ×§×‘×•×¦×ª ×‘×§×¨×”?", a: "×§×‘×•×¦×” ×©×œ× ××§×‘×œ×ª ××ª ×”×˜×™×¤×•×œ ×‘× ×™×¡×•×™, ××©××©×ª ×œ×”×©×•×•××” ×›×“×™ ×œ×”×•×›×™×— ××ª ×¡×™×‘×ª ×”×©×™× ×•×™." },
                    { q: "××”×™ ×©××œ×ª ×—×§×¨?", a: "×©××œ×” ×”×× ×¡×—×ª ××ª ×”×‘×¢×™×” ×•×‘×•×“×§×ª ×§×©×¨ ×‘×™×Ÿ ××©×ª× ×” ×‘×œ×ª×™ ×ª×œ×•×™ ×œ××©×ª× ×” ×ª×œ×•×™." }
                ]
            },
            {
                name: "××™×•×× ×•×™×•×ª",
                content: `
                    <ul>
                        <li><strong>××××¨ ××“×¢×™:</strong> × ×›×ª×‘ ×¢"×™ ×—×•×§×¨×™×, ×©×¤×” ××§×¦×•×¢×™×ª, ××•×‘×™×™×§×˜×™×‘×™, ×‘×™×§×•×¨×ª ×¢××™×ª×™×.</li>
                        <li><strong>××××¨ ×¤×•×¤×•×œ×¨×™:</strong> × ×›×ª×‘ ×¢"×™ ×¢×™×ª×•× ××™×, ×œ×§×”×œ ×”×¨×—×‘, ×©×¤×” ×™×•××™×•××™×ª.</li>
                        <li><strong>×˜×™×¢×•×Ÿ:</strong> ×˜×¢× ×” + × ×™××•×§ (×¨××™×” ××• ×”×¡×‘×¨).</li>
                        <li><strong>×’×¨×¤×™×:</strong>
                            <ul>
                                <li>×’×¨×£ ×¨×¦×™×£: ×§×©×¨ ×‘×™×Ÿ ××©×ª× ×™× ×¨×¦×™×¤×™× (XY).</li>
                                <li>×’×¨×£ ×¢××•×“×•×ª: ×”×©×•×•××” ×‘×™×Ÿ ×§×‘×•×¦×•×ª ×‘×“×™×“×•×ª.</li>
                                <li>×’×¨×£ ×¢×•×’×”: ×—×œ×§×™× ××ª×•×š ×©×œ×.</li>
                            </ul>
                        </li>
                    </ul>`,
                flashcards: [
                    { q: "××” ×”×”×‘×“×œ ×‘×™×Ÿ ××××¨ ××“×¢×™ ×œ×¤×•×¤×•×œ×¨×™?", a: "××“×¢×™: ×—×•×§×¨×™×, ×‘×™×§×•×¨×ª ×¢××™×ª×™×. ×¤×•×¤×•×œ×¨×™: ×¢×™×ª×•× ××™×, ×œ×§×”×œ ×”×¨×—×‘." },
                    { q: "×××” ××•×¨×›×‘ ××©×¤×˜ ×˜×™×¢×•×Ÿ?", a: "×˜×¢× ×” + × ×™××•×§ ××—×“ ××• ×™×•×ª×¨." },
                    { q: "××ª×™ × ×©×ª××© ×‘×’×¨×£ ×¨×¦×™×£?", a: "×›×©×™×© ×§×©×¨ ××• ×ª×œ×•×ª ×‘×™×Ÿ ×©× ×™ ××©×ª× ×™× ×¨×¦×™×¤×™× (×œ×›×œ × ×§×•×“×” ×¢×¨×š X ×•-Y)." }
                ]
            },
            {
                name: "×¢×™×©×•×Ÿ ×•× ×–×§×™×•",
                content: `
                    <strong>×—×•××¨×™× ××¡×•×›× ×™×:</strong>
                    <ul>
                        <li><strong>× ×™×§×•×˜×™×Ÿ:</strong> ×××›×¨, ××›×•×•×¥ ×›×œ×™ ×“×, ××¢×œ×” ×œ×—×¥ ×“×.</li>
                        <li><strong>×¢×™×˜×¨×Ÿ (×–×¤×ª):</strong> ××¡×¨×˜×Ÿ, × ×“×‘×§ ×œ×¨×™××•×ª ×•×—×•×¡× ××•×ª×Ÿ.</li>
                        <li><strong>×¤×—××Ÿ ×—×“-×—××¦× ×™ (CO):</strong> ××ª×—×¨×” ×¢× ×”×—××¦×Ÿ ×¢×œ ×”×”××•×’×œ×•×‘×™×Ÿ, ×’×•×¨× ×œ×—×•×¡×¨ ×—××¦×Ÿ.</li>
                    </ul>
                    <strong>×¡×•×’×™× × ×•×¡×¤×™×:</strong>
                    <ul>
                        <li><strong>× ×¨×’×™×œ×”:</strong> ×”××™× ×œ× ××¡× × ×™× ×¨×¢×œ×™×. ××¡×•×›× ×ª ×›××• ×¡×™×’×¨×™×”.</li>
                        <li><strong>×¡×™×’×¨×™×” ××œ×§×˜×¨×•× ×™×ª:</strong> ×’×•×¨××ª ×œ×“×œ×§×ª ×¨×™××•×ª ×›×™××™×ª.</li>
                    </ul>`,
                flashcards: [
                    { q: "××” ×”×¡×›× ×” ×‘×¤×—××Ÿ ×—×“-×—××¦× ×™ (CO)?", a: "×”×•× × ×§×©×¨ ×œ×”××•×’×œ×•×‘×™×Ÿ ×‘××§×•× ×”×—××¦×Ÿ ×•××•× ×¢ ×”×’×¢×ª ×—××¦×Ÿ ×œ×ª××™×." },
                    { q: "××”×• ×”×¢×™×˜×¨×Ÿ?", a: "×—×•××¨ ×“××•×™ ×–×¤×ª, ××¡×¨×˜×Ÿ, ×©× ×“×‘×§ ×œ×¨×™××•×ª ×•×’×•×¨× ×œ×—×¡×™××ª ×“×¨×›×™ ×”× ×©×™××”." },
                    { q: "×”×× ××™× ×‘× ×¨×’×™×œ×” ××¡× × ×™× ×¨×¢×œ×™×?", a: "×œ×. ×”××™× ×œ× ××¡× × ×™× × ×™×§×•×˜×™×Ÿ ×•×¢×™×˜×¨×Ÿ, ×•×”× ×¨×’×™×œ×” ××¡×•×›× ×ª ×××•×“." },
                    { q: "××” ×”× ×–×§ ×©×œ ×¡×™×’×¨×™×” ××œ×§×˜×¨×•× ×™×ª?", a: "×“×œ×§×ª ×¨×™××•×ª ×›×™××™×ª ×•×§×¨×™×¡×ª ×¨×™××•×ª." }
                ],
                children: [
                   { name: "CO (×¤×—××Ÿ ×—×“ ×—××¦× ×™)", content: "×’×– ×¨×¢×™×œ, ×œ×œ× ×¨×™×—. ××•× ×¢ ×—××¦×Ÿ ××”×“×."},
                   { name: "× ×™×§×•×˜×™×Ÿ", content: "×”×—×•××¨ ×”×××›×¨. ××›×•×•×¥ ×›×œ×™ ×“× ×•××¢×œ×” ×“×•×¤×§."},
                   { name: "×¢×™×˜×¨×Ÿ", content: "×”×—×•××¨ ×”××¡×¨×˜×Ÿ (×–×¤×ª). × ×“×‘×§ ×œ×¨×™××•×ª."}
                ]
            }
        ]
    };

    // --- Visualization Setup ---
    const container = document.getElementById("mindmap-container");
    let width = container.clientWidth;
    let height = container.clientHeight;

    const svg = d3.select("#mindmap-container").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", `0 0 ${width} ${height}`)
        .on("dblclick.zoom", null); 

    const g = svg.append("g");

    // Zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.5, 2])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });

    svg.call(zoom);

    let i = 0;
    const duration = 500;
    const root = d3.hierarchy(data, d => d.children);
    
    // Initial position
    root.x0 = height / 2;
    root.y0 = 100;

    // Increased spacing for pill boxes
    let treeMap = d3.tree().nodeSize([60, 250]); 

    // --- Logic ---
    root.children.forEach(collapse);
    update(root);
    
    // Center the tree initially
    const initialTransform = d3.zoomIdentity.translate(width/6, height/2).scale(0.9);
    svg.call(zoom.transform, initialTransform);

    function collapse(d) {
        if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
        }
    }

    function update(source) {
        const treeData = treeMap(root);
        const nodes = treeData.descendants();
        const links = treeData.links();

        // Nodes
        const node = g.selectAll('g.node')
            .data(nodes, d => d.id || (d.id = ++i));

        // Enter Phase
        const nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr("transform", d => `translate(${source.y0},${source.x0})`)
            .on('click', click);

        // 1. Circle Joint
        nodeEnter.append('circle')
            .attr('class', 'node-circle')
            .attr('r', 1e-6)
            .style("fill", d => d._children ? "#3498db" : "#fff");

        // 2. Pill Group (Rect + Text)
        const pillGroup = nodeEnter.append('g')
            .attr('class', 'pill-group')
            .style('opacity', 0); // Hide initially

        pillGroup.append('rect')
            .attr('rx', 12)
            .attr('ry', 12)
            .attr('class', 'pill-rect');

        pillGroup.append('text')
            .attr('dy', '.35em')
            .attr('class', 'pill-text')
            .attr('text-anchor', 'middle')
            .text(d => d.data.name);

        // Update Phase
        const nodeUpdate = node.merge(nodeEnter).transition().duration(duration)
            .attr("transform", d => `translate(${d.y},${d.x})`);

        nodeUpdate.select('circle')
            .attr('r', 6)
            .style("fill", d => d._children ? "#3498db" : "#fff");

        // Dynamic Pill Sizing and Positioning
        nodeUpdate.select('.pill-group')
            .style('opacity', 1)
            .each(function(d) {
                const group = d3.select(this);
                const text = group.select('text');
                const rect = group.select('rect');
                
                // Measure text
                const bbox = text.node().getBBox();
                const paddingX = 24;
                const paddingY = 12;
                const width = bbox.width + paddingX;
                const height = bbox.height + paddingY;
                
                // Determine direction (Parents left, Leaves right)
                const isParent = d.children || d._children;
                const offset = 15; // Distance from circle
                
                // Resize rect
                rect.attr('width', width)
                    .attr('height', height)
                    .attr('y', -height/2);
                    
                if (isParent) {
                    // Place to the left
                    rect.attr('x', -(width + offset));
                    text.attr('x', -(width/2 + offset));
                } else {
                    // Place to the right
                    rect.attr('x', offset);
                    text.attr('x', offset + width/2);
                }
            });

        // Exit Phase
        const nodeExit = node.exit().transition().duration(duration)
            .attr("transform", d => `translate(${source.y},${source.x})`)
            .remove();

        nodeExit.select('circle').attr('r', 1e-6);
        nodeExit.style('opacity', 1e-6);

        // Links
        const link = g.selectAll('path.link')
            .data(links, d => d.target.id);

        const linkEnter = link.enter().insert('path', "g")
            .attr("class", "link")
            .attr('d', d => {
                const o = {x: source.x0, y: source.y0};
                return diagonal(o, o);
            });

        const linkUpdate = link.merge(linkEnter).transition().duration(duration)
            .attr('d', d => diagonal(d.source, d.target));

        const linkExit = link.exit().transition().duration(duration)
            .attr('d', d => {
                const o = {x: source.x, y: source.y};
                return diagonal(o, o);
            })
            .remove();

        nodes.forEach(d => {
            d.x0 = d.x;
            d.y0 = d.y;
        });

        function diagonal(s, d) {
            if (!s || !d) return "";
            const sy = (s.y !== undefined) ? s.y : 0;
            const sx = (s.x !== undefined) ? s.x : 0;
            const dy = (d.y !== undefined) ? d.y : 0;
            const dx = (d.x !== undefined) ? d.x : 0;

            return `M ${sy} ${sx}
                    C ${(sy + dy) / 2} ${sx},
                      ${(sy + dy) / 2} ${dx},
                      ${dy} ${dx}`;
        }
    }

    function click(event, d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
        update(d);
        showDetails(d.data);
    }

    function showDetails(dataObj) {
        document.getElementById('detail-title').innerText = dataObj.name;
        document.getElementById('detail-subtitle').innerText = "× ×•×©× × ×‘×—×¨";

        document.getElementById('welcome-msg').style.display = 'none';
        const detailView = document.getElementById('detail-view');
        detailView.style.display = 'block';

        const contentDiv = document.getElementById('detail-content');
        contentDiv.style.opacity = 0;
        setTimeout(() => {
            contentDiv.innerHTML = dataObj.content || "××™×Ÿ ××™×“×¢ × ×•×¡×£.";
            contentDiv.style.opacity = 1;
        }, 150);

        const btn = document.getElementById('start-cards-btn');
        if (dataObj.flashcards && dataObj.flashcards.length > 0) {
            btn.style.display = 'flex';
            btn.onclick = () => openFlashcards(dataObj.flashcards);
        } else {
            btn.style.display = 'none';
        }
    }

    // --- Flashcards Logic ---
    let currentFlashcards = [];
    let currentCardIndex = 0;

    function openFlashcards(cards) {
        currentFlashcards = cards;
        currentCardIndex = 0;
        showCard(0);
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function showCard(index) {
        const container = document.querySelector('.flashcard-container');
        container.classList.remove('flipped');
        
        setTimeout(() => {
            const card = currentFlashcards[index];
            document.getElementById('card-question').innerText = card.q;
            document.getElementById('card-answer').innerText = card.a;
            document.getElementById('card-counter').innerText = `${index + 1} / ${currentFlashcards.length}`;
        }, 200);
    }

    function flipCard() {
        document.querySelector('.flashcard-container').classList.toggle('flipped');
    }

    function nextCard(e) {
        e.stopPropagation();
        if (currentCardIndex < currentFlashcards.length - 1) {
            currentCardIndex++;
            showCard(currentCardIndex);
        }
    }

    function prevCard(e) {
        e.stopPropagation();
        if (currentCardIndex > 0) {
            currentCardIndex--;
            showCard(currentCardIndex);
        }
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    window.addEventListener("resize", () => {
        width = container.clientWidth;
        height = container.clientHeight;
        svg.attr("width", width).attr("height", height);
    });

</script>
</body>
</html>